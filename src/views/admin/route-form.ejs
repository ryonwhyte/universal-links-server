<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head', { title: title, suffix: ' - Universal Links Admin' }) %>
</head>
<body>
  <main class="container">
    <%- include('../partials/admin-nav', { backUrl: '/admin/apps/' + app.id + '/routes', backText: 'Back to Routes', user: user }) %>

    <h1><%= title %></h1>

    <% if (error) { %>
      <article style="background: var(--pico-color-red-100);">
        <p style="color: var(--pico-color-red-700); margin: 0;"><%= error %></p>
      </article>
    <% } %>

    <form method="POST" action="/admin/apps/<%= app.id %>/routes/<%= route?.id ? route.id : 'new' %>">
      <%- include('../partials/csrf') %>
      <label>
        Prefix *
        <input type="text" name="prefix" value="<%= route?.prefix || '' %>" required pattern="[a-z0-9-]+" placeholder="m">
        <small>URL prefix like <code>m</code> for <code>/m/token</code>. Lowercase letters, numbers, hyphens only.</small>
      </label>

      <label>
        Name *
        <input type="text" name="name" value="<%= route?.name || '' %>" required placeholder="Merchant">
        <small>Human-readable name for this route type.</small>
      </label>

      <label>
        Template
        <select name="template">
          <% templates.forEach(t => { %>
            <option value="<%= t %>" <%= route?.template === t ? 'selected' : '' %>><%= t === 'none' ? 'none (redirect only)' : t %></option>
          <% }); %>
        </select>
        <small>Landing page template. Select "none" to skip the landing page and redirect mobile users directly to the app store.</small>
      </label>

      <label>
        API Endpoint
        <input type="url" name="api_endpoint" value="<%= route?.api_endpoint || '' %>" placeholder="https://api.example.com/public/item/{token}">
        <small>Optional. Use <code>{token}</code> as placeholder for the token value.</small>
      </label>

      <label>
        Web Fallback URL
        <input type="url" name="web_fallback_url" value="<%= route?.web_fallback_url || '' %>" placeholder="https://example.com/store/{token}">
        <small>Optional. Desktop users redirect here. Use <code>{token}</code> for the token value.</small>
      </label>

      <fieldset>
        <label>
          <input type="checkbox" name="universal_link_enabled" <%= route?.universal_link_enabled || route?.universal_link_enabled === undefined ? 'checked' : '' %>>
          Enable Universal Links
        </label>
        <small>Include this route in iOS/Android app link configuration.</small>
      </fieldset>

      <fieldset>
        <legend>Social Media Preview (Optional)</legend>
        <small style="display: block; margin-bottom: 1rem;">Override app-level settings for this specific route.</small>

        <label>
          <input type="checkbox" name="og_fetch_from_fallback" value="1" <%= route?.og_fetch_from_fallback ? 'checked' : '' %>>
          Fetch preview from web fallback URL
        </label>
        <small style="display: block; margin-bottom: 1rem;">Dynamically fetch OG tags from the web fallback destination. Useful for routes with dynamic tokens.</small>

        <label>
          Preview Title
          <input type="text" name="og_title" value="<%= route?.og_title || '' %>" placeholder="Leave blank to use app default">
        </label>

        <label>
          Preview Description
          <textarea name="og_description" placeholder="Leave blank to use app default"><%= route?.og_description || '' %></textarea>
        </label>

        <label>
          Preview Image URL
          <input type="url" name="og_image" value="<%= route?.og_image || '' %>" placeholder="Leave blank to use app default">
        </label>
      </fieldset>

      <button type="submit"><%= route?.id ? 'Save Changes' : 'Create Route' %></button>
    </form>
  </main>
</body>
</html>
